unit EtaTaxe;

interface

uses
  Windows, Messages, SysUtils, Classes, Graphics, Controls, Forms, Dialogs,
  Qrctrls, quickrpt, ExtCtrls, StdCtrls;

type
  TFEtatTaxe = class(TForm)
    QuickRep9: TQuickRep;
    QRBand19: TQRBand;
    QRShape241: TQRShape;
    QRLabel307: TQRLabel;
    QRLabel308: TQRLabel;
    QRLabel309: TQRLabel;
    QRLabel310: TQRLabel;
    QRLabel311: TQRLabel;
    QRLabel312: TQRLabel;
    QRShape242: TQRShape;
    QRLabel313: TQRLabel;
    QRShape245: TQRShape;
    QRLabel314: TQRLabel;
    QRLabel315: TQRLabel;
    QRLabel316: TQRLabel;
    QRLabel318: TQRLabel;
    QRLabel319: TQRLabel;
    QRLabel370: TQRLabel;
    QRDBText44: TQRDBText;
    QRLabel371: TQRLabel;
    QRLabel372: TQRLabel;
    QRBand20: TQRBand;
    QRShape246: TQRShape;
    QRShape251: TQRShape;
    QRLabel373: TQRLabel;
    QRShape252: TQRShape;
    QRShape253: TQRShape;
    QRShape257: TQRShape;
    QRShape258: TQRShape;
    QRShape280: TQRShape;
    QRShape282: TQRShape;
    QRLabel374: TQRLabel;
    QRLabel375: TQRLabel;
    QRLabel376: TQRLabel;
    QRLabel377: TQRLabel;
    QRLabel378: TQRLabel;
    QRLabel379: TQRLabel;
    QRLabel380: TQRLabel;
    QRLabel381: TQRLabel;
    QRLabel382: TQRLabel;
    QRLabel383: TQRLabel;
    QRLabel384: TQRLabel;
    QRLabel385: TQRLabel;
    QRLabel386: TQRLabel;
    QRLabel387: TQRLabel;
    QRShape283: TQRShape;
    QRLabel388: TQRLabel;
    QRLabel389: TQRLabel;
    QRLabel390: TQRLabel;
    QRLabel392: TQRLabel;
    QRLabel393: TQRLabel;
    QRLabel394: TQRLabel;
    QRLabel395: TQRLabel;
    QRLabel396: TQRLabel;
    QRLabel397: TQRLabel;
    QRLabel398: TQRLabel;
    QRLabel399: TQRLabel;
    QRLabel400: TQRLabel;
    QRLabel401: TQRLabel;
    QRLabel402: TQRLabel;
    QRLabel403: TQRLabel;
    QRLabel404: TQRLabel;
    QRLabel405: TQRLabel;
    QRShape284: TQRShape;
    QRShape285: TQRShape;
    QRShape289: TQRShape;
    QRShape292: TQRShape;
    QRShape293: TQRShape;
    QRShape294: TQRShape;
    QRShape295: TQRShape;
    QRShape296: TQRShape;
    QRShape297: TQRShape;
    QRLabel406: TQRLabel;
    Locaux: TQRLabel;
    QRLabel407: TQRLabel;
    QRLabel408: TQRLabel;
    QRLabel409: TQRLabel;
    QRLabel411: TQRLabel;
    QRLabel412: TQRLabel;
    QRLabel413: TQRLabel;
    QRLabel414: TQRLabel;
    QRLabel415: TQRLabel;
    QRLabel416: TQRLabel;
    QRLabel417: TQRLabel;
    QRShape298: TQRShape;
    QRLabel418: TQRLabel;
    QRLabel419: TQRLabel;
    QRLabel420: TQRLabel;
    QRLabel421: TQRLabel;
    QRShape299: TQRShape;
    QRLabel422: TQRLabel;
    QRLabel423: TQRLabel;
    QRLabel424: TQRLabel;
    QRLabel425: TQRLabel;
    QRLabel426: TQRLabel;
    QRLabel427: TQRLabel;
    QRLabel428: TQRLabel;
    QRLabel429: TQRLabel;
    QRLabel430: TQRLabel;
    QRLabel431: TQRLabel;
    QRLabel432: TQRLabel;
    QRLabel433: TQRLabel;
    QRLabel434: TQRLabel;
    QRLabel435: TQRLabel;
    QRLabel436: TQRLabel;
    QRLabel437: TQRLabel;
    QRLabel438: TQRLabel;
    QRLabel439: TQRLabel;
    QRLabel440: TQRLabel;
    QRLabel441: TQRLabel;
    QRLabel442: TQRLabel;
    QRLabel443: TQRLabel;
    QRLabel444: TQRLabel;
    QRLabel445: TQRLabel;
    QRLabel446: TQRLabel;
    QRLabel447: TQRLabel;
    QRLabel448: TQRLabel;
    QRLabel449: TQRLabel;
    QRLabel450: TQRLabel;
    QRLabel451: TQRLabel;
    QRLabel452: TQRLabel;
    QRLabel453: TQRLabel;
    QRLabel454: TQRLabel;
    QRLabel461: TQRLabel;
    QRLabel391: TQRLabel;
    QRShape300: TQRShape;
    QRShape301: TQRShape;
    QRShape302: TQRShape;
    QRLabel455: TQRLabel;
    QRShape303: TQRShape;
    QRShape304: TQRShape;
    QRShape305: TQRShape;
    QRShape306: TQRShape;
    QRLabel456: TQRLabel;
    QRLabel457: TQRLabel;
    QRLabel458: TQRLabel;
    QRLabel459: TQRLabel;
    QRLabel460: TQRLabel;
    QRLabel1: TQRLabel;
    QRLabel2: TQRLabel;
    QRLabel3: TQRLabel;
    QRLabel4: TQRLabel;
    QRLabel5: TQRLabel;
    QRLabel6: TQRLabel;
    QRLabel7: TQRLabel;
    QRLabel8: TQRLabel;
    QRLabel9: TQRLabel;
    QRLabel10: TQRLabel;
    QuickRep4: TQuickRep;
    QRBand16: TQRBand;
    QRSysData9: TQRSysData;
    QRSysData10: TQRSysData;
    QRBand17: TQRBand;
    QRLabel67: TQRLabel;
    QRShape66: TQRShape;
    QRBand18: TQRBand;
    Detail: TQRLabel;
    QRBand1: TQRBand;
    Fournisseur: TQRLabel;
    QRShape57: TQRShape;
    QRLabel62: TQRLabel;
    QRShape60: TQRShape;
    QRLabel55: TQRLabel;
    QRLabel54: TQRLabel;
    QRShape20: TQRShape;
    QRLabel58: TQRLabel;
    QRLabel59: TQRLabel;
    QRShape56: TQRShape;
    QRLabel11: TQRLabel;
    QRShape1: TQRShape;
    QRShape3: TQRShape;
    QRBand14: TQRBand;
    QRDBText7: TQRDBText;
    QRShape50: TQRShape;
    QRShape54: TQRShape;
    QRShape55: TQRShape;
    QRDBText37: TQRDBText;
    QRDBText40: TQRDBText;
    QRShape51: TQRShape;
    QRDBText33: TQRDBText;
    QRShape2: TQRShape;
    QRDBText1: TQRDBText;
    QRShape4: TQRShape;
    QRDBText2: TQRDBText;
    QRExpr1: TQRExpr;
    QRLabel12: TQRLabel;
    QRSysData1: TQRSysData;
    QRLabel13: TQRLabel;
    QRLabel14: TQRLabel;
    QRLabel15: TQRLabel;
    QRLabel16: TQRLabel;
    QRLabel17: TQRLabel;
    QRLabel18: TQRLabel;
    QRLabel19: TQRLabel;
    QRLabel20: TQRLabel;
    QRLabel21: TQRLabel;
    QRLabel22: TQRLabel;
    QRDBText3: TQRDBText;
    QRExpr3: TQRExpr;
    QRExpr2: TQRExpr;
    QuickRep1: TQuickRep;
    QRBand2: TQRBand;
    QRSysData3: TQRSysData;
    QRBand3: TQRBand;
    QRExpr5: TQRExpr;
    QRBand4: TQRBand;
    QRLabel24: TQRLabel;
    QRBand5: TQRBand;
    QRLabel25: TQRLabel;
    QRLabel26: TQRLabel;
    QRShape7: TQRShape;
    QRLabel27: TQRLabel;
    QRLabel28: TQRLabel;
    QRShape8: TQRShape;
    QRLabel29: TQRLabel;
    QRLabel30: TQRLabel;
    QRShape9: TQRShape;
    QRShape10: TQRShape;
    QRShape11: TQRShape;
    QRBand6: TQRBand;
    QRDBText4: TQRDBText;
    QRShape12: TQRShape;
    QRShape13: TQRShape;
    QRShape14: TQRShape;
    QRDBText5: TQRDBText;
    QRDBText6: TQRDBText;
    QRShape15: TQRShape;
    QRShape16: TQRShape;
    QRShape17: TQRShape;
    QRDBText12: TQRDBText;
    QRDBText13: TQRDBText;
    QRLabel31: TQRLabel;
    QRDBText10: TQRDBText;
    QRDBText8: TQRDBText;
    QuickRep2: TQuickRep;
    QRBand7: TQRBand;
    QRSysData5: TQRSysData;
    QRBand8: TQRBand;
    QRShape18: TQRShape;
    QRExpr4: TQRExpr;
    QRBand9: TQRBand;
    QRLabel23: TQRLabel;
    QRBand10: TQRBand;
    QRLabel33: TQRLabel;
    QRLabel34: TQRLabel;
    QRLabel35: TQRLabel;
    QRShape22: TQRShape;
    QRLabel37: TQRLabel;
    QRShape23: TQRShape;
    QRShape24: TQRShape;
    QRShape25: TQRShape;
    QRBand11: TQRBand;
    QRDBText14: TQRDBText;
    QRShape26: TQRShape;
    QRDBText15: TQRDBText;
    QRDBText16: TQRDBText;
    QRShape29: TQRShape;
    QRShape30: TQRShape;
    QRShape31: TQRShape;
    QRDBText17: TQRDBText;
    QRDBText18: TQRDBText;
    QRGroup1: TQRGroup;
    QRBand12: TQRBand;
    QRExpr6: TQRExpr;
    QRShape32: TQRShape;
    QRSysData4: TQRSysData;
    QRSysData6: TQRSysData;
    QRLabel32: TQRLabel;
    QRLabel36: TQRLabel;
    QRLabel38: TQRLabel;
    QRShape19: TQRShape;
    QRShape21: TQRShape;
    QRShape28: TQRShape;
    QRShape33: TQRShape;
    QRShape34: TQRShape;
    QRShape35: TQRShape;
    QRShape36: TQRShape;
    QRExpr7: TQRExpr;
    QRExpr8: TQRExpr;
    QRShape27: TQRShape;
    QRLabel43: TQRLabel;
    QRDBText19: TQRDBText;
    QRShape37: TQRShape;
    QRBand13: TQRBand;
    QRExpr10: TQRExpr;
    QRGroup2: TQRGroup;
    QRExpr11: TQRExpr;
    QRExpr9: TQRExpr;
    QRShape38: TQRShape;
    QRShape39: TQRShape;
    QRShape40: TQRShape;
    QRShape5: TQRShape;
    QuickRep3: TQuickRep;
    QRBand15: TQRBand;
    QRSysData2: TQRSysData;
    QRSysData7: TQRSysData;
    QRBand21: TQRBand;
    QRLabel44: TQRLabel;
    QRBand22: TQRBand;
    QRLabel47: TQRLabel;
    QRBand23: TQRBand;
    QRLabel48: TQRLabel;
    QRShape43: TQRShape;
    QRLabel53: TQRLabel;
    QRLabel56: TQRLabel;
    QRShape45: TQRShape;
    QRBand24: TQRBand;
    QRDBText20: TQRDBText;
    QRShape47: TQRShape;
    QRShape48: TQRShape;
    QRShape49: TQRShape;
    QRDBText21: TQRDBText;
    QRDBText22: TQRDBText;
    QRDBText23: TQRDBText;
    QRShape53: TQRShape;
    QRDBText24: TQRDBText;
    QRShape58: TQRShape;
    QRDBText25: TQRDBText;
    QRDBText26: TQRDBText;
    QRGroup3: TQRGroup;
    QRBand25: TQRBand;
    QRDBText27: TQRDBText;
    QRDBText28: TQRDBText;
    QRGroup4: TQRGroup;
    QRDBText29: TQRDBText;
    QRBand27: TQRBand;
    QRDBText31: TQRDBText;
    QRExpr15: TQRExpr;
    QRExpr12: TQRExpr;
    QRDBText30: TQRDBText;
    QRShape6: TQRShape;
    QuickRep5: TQuickRep;
    QRBand26: TQRBand;
    QRSysData8: TQRSysData;
    QRSysData11: TQRSysData;
    QRBand28: TQRBand;
    QRLabel49: TQRLabel;
    QRExpr14: TQRExpr;
    QRBand29: TQRBand;
    QRLabel50: TQRLabel;
    QRBand30: TQRBand;
    QRLabel57: TQRLabel;
    QRShape42: TQRShape;
    QRBand31: TQRBand;
    QRDBText32: TQRDBText;
    QRShape44: TQRShape;
    QRShape46: TQRShape;
    QRDBText34: TQRDBText;
    QRDBText35: TQRDBText;
    QRShape61: TQRShape;
    QRDBText36: TQRDBText;
    QRShape62: TQRShape;
    QRDBText38: TQRDBText;
    QRShape63: TQRShape;
    QRDBText39: TQRDBText;
    QRDBText41: TQRDBText;
    QRGroup5: TQRGroup;
    QRDBText42: TQRDBText;
    QRBand32: TQRBand;
    QRExpr16: TQRExpr;
    QRDBText46: TQRDBText;
    QRDBText45: TQRDBText;
    QRLabel51: TQRLabel;
    QRLabel52: TQRLabel;
    QRLabel60: TQRLabel;
    QRLabel61: TQRLabel;
    QRShape65: TQRShape;
    QRLabel63: TQRLabel;
    QRLabel64: TQRLabel;
    QRShape67: TQRShape;
    QRGroup6: TQRGroup;
    QRDBText43: TQRDBText;
    QRDBText47: TQRDBText;
    QRBand33: TQRBand;
    QRExpr17: TQRExpr;
    QRDBText48: TQRDBText;
    QRExpr19: TQRExpr;
    QRLabel202: TQRLabel;
    QRDBText62: TQRDBText;
    QRDBText49: TQRDBText;
    QRLabel65: TQRLabel;
    QRLabel66: TQRLabel;
    QRDBText50: TQRDBText;
    QRLabel69: TQRLabel;
    QRDBText52: TQRDBText;
    QRLabel71: TQRLabel;
    QRDBText54: TQRDBText;
    QRDBText55: TQRDBText;
    QRLabel73: TQRLabel;
    QRDBText56: TQRDBText;
    QRDBText58: TQRDBText;
    QRLabel68: TQRLabel;
    QRDBText59: TQRDBText;
    QRLabel72: TQRLabel;
    QRDBText60: TQRDBText;
    QRLabel70: TQRLabel;
    QRDBText61: TQRDBText;
    QRLabel75: TQRLabel;
    QRDBText63: TQRDBText;
    QRLabel74: TQRLabel;
    QRDBText64: TQRDBText;
    QuickRep6: TQuickRep;
    QRBand34: TQRBand;
    QRSysData12: TQRSysData;
    QRSysData13: TQRSysData;
    QRBand35: TQRBand;
    QRLabel76: TQRLabel;
    QRExpr20: TQRExpr;
    QRBand36: TQRBand;
    QRLabel77: TQRLabel;
    QRLabel78: TQRLabel;
    QRDBText65: TQRDBText;
    QRLabel79: TQRLabel;
    QRDBText67: TQRDBText;
    QRBand37: TQRBand;
    QRLabel80: TQRLabel;
    QRShape69: TQRShape;
    QRLabel81: TQRLabel;
    QRShape70: TQRShape;
    QRLabel82: TQRLabel;
    QRShape71: TQRShape;
    QRLabel83: TQRLabel;
    QRLabel84: TQRLabel;
    QRShape72: TQRShape;
    QRLabel85: TQRLabel;
    QRLabel86: TQRLabel;
    QRShape73: TQRShape;
    QRBand38: TQRBand;
    QRDBText68: TQRDBText;
    QRShape75: TQRShape;
    QRShape76: TQRShape;
    QRShape77: TQRShape;
    QRDBText69: TQRDBText;
    QRDBText70: TQRDBText;
    QRShape78: TQRShape;
    QRDBText71: TQRDBText;
    QRShape79: TQRShape;
    QRDBText72: TQRDBText;
    QRShape80: TQRShape;
    QRDBText73: TQRDBText;
    QRDBText74: TQRDBText;
    QRGroup8: TQRGroup;
    QRDBText78: TQRDBText;
    QRDBText79: TQRDBText;
    QRBand40: TQRBand;
    Label4: TLabel;
    QRExpr22: TQRExpr;
    QRDBText80: TQRDBText;
    QRLabel87: TQRLabel;
    QRDBText81: TQRDBText;
    QRShape81: TQRShape;
    QRDBText82: TQRDBText;
    QRLabel88: TQRLabel;
    QRShape82: TQRShape;
    QRExpr21: TQRExpr;
    QRExpr23: TQRExpr;
    QRShape83: TQRShape;
    QRShape84: TQRShape;
    QRShape85: TQRShape;
    QRShape86: TQRShape;
    QRLabel89: TQRLabel;
    QRShape87: TQRShape;
    QRShape52: TQRShape;
    QRShape89: TQRShape;
    QRShape90: TQRShape;
    QRExpr24: TQRExpr;
    QRShape88: TQRShape;
    QRShape91: TQRShape;
    QRShape92: TQRShape;
    QRShape93: TQRShape;
    QRShape94: TQRShape;
    QRLabel93: TQRLabel;
    QRLabel94: TQRLabel;
    QRLabel95: TQRLabel;
    QRLabel96: TQRLabel;
    QRLabel97: TQRLabel;
    QRLabel98: TQRLabel;
    QRLabel99: TQRLabel;
    QRLabel100: TQRLabel;
    QRLabel101: TQRLabel;
    QRLabel102: TQRLabel;
    QRLabel103: TQRLabel;
    QRLabel104: TQRLabel;
    QRDBText75: TQRDBText;
    QRLabel105: TQRLabel;
    QRLabel106: TQRLabel;
    QRShape95: TQRShape;
    QRShape96: TQRShape;
    QRShape97: TQRShape;
    QRDBText76: TQRDBText;
    QRLabel107: TQRLabel;
    QRLabel108: TQRLabel;
    QRShape98: TQRShape;
    QRShape99: TQRShape;
    QRShape100: TQRShape;
    QRShape64: TQRShape;
    QRShape41: TQRShape;
    QRShape102: TQRShape;
    QRDBText77: TQRDBText;
    QRLabel109: TQRLabel;
    QRShape101: TQRShape;
    QRShape103: TQRShape;
    QRShape104: TQRShape;
    QRDBText9: TQRDBText;
    QRDBText88: TQRDBText;
    QRDBText86: TQRDBText;
    QRDBText87: TQRDBText;
    QRDBText83: TQRDBText;
    QRDBText84: TQRDBText;
    QRExpr13: TQRExpr;
    QRExpr25: TQRExpr;
    QRExpr26: TQRExpr;
    QRShape59: TQRShape;
    QRShape105: TQRShape;
    QRShape106: TQRShape;
    QRShape107: TQRShape;
    QRDBText89: TQRDBText;
    QRLabel110: TQRLabel;
    QRLabel240: TQRLabel;
    QRLabel111: TQRLabel;
    QRLabel112: TQRLabel;
    QRLabel113: TQRLabel;
    QRLabel114: TQRLabel;
    QRLabel115: TQRLabel;
    QRLabel116: TQRLabel;
    QRLabel117: TQRLabel;
    QRDBText11: TQRDBText;
    QRLabel118: TQRLabel;
    QRExpr18: TQRExpr;
    QRExpr27: TQRExpr;
    QRExpr28: TQRExpr;
    QRExpr29: TQRExpr;
    QRExpr30: TQRExpr;
    QRExpr31: TQRExpr;
    QRExpr32: TQRExpr;
    QRExpr33: TQRExpr;
    QRExpr34: TQRExpr;
    QRDBText51: TQRDBText;
    QRLabel39: TQRLabel;
    QRLabel40: TQRLabel;
    QRDBText53: TQRDBText;
    QRLabel41: TQRLabel;
    QRDBText57: TQRDBText;
    QRDBText66: TQRDBText;
    QRLabel42: TQRLabel;
    QRLabel45: TQRLabel;
    QRDBText85: TQRDBText;
    QRDBText90: TQRDBText;
    QRLabel46: TQRLabel;
    QRLabel90: TQRLabel;
    QRDBText91: TQRDBText;
    QRLabel91: TQRLabel;
    QRLabel92: TQRLabel;
    QRLabel119: TQRLabel;
    QRLabel120: TQRLabel;
    QRLabel121: TQRLabel;
    QRDBText92: TQRDBText;
    QRLabel122: TQRLabel;
    QRLabel123: TQRLabel;
    QRLabel124: TQRLabel;
    QRLabel125: TQRLabel;
    QRLabel126: TQRLabel;
    QRDBText93: TQRDBText;
    QRLabel127: TQRLabel;
    QRDBText94: TQRDBText;
    procedure QRBand11BeforePrint(Sender: TQRCustomBand;
      var PrintBand: Boolean);
    procedure QRDBText31Print(sender: TObject; var Value: String);
    procedure QRBand38BeforePrint(Sender: TQRCustomBand;
      var PrintBand: Boolean);
    procedure QuickRep9BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
    procedure QuickRep1BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
    procedure QuickRep2BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
    procedure QuickRep4BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
    procedure QuickRep3BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
    procedure QuickRep6BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
    procedure QuickRep5BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
    procedure QRBand33BeforePrint(Sender: TQRCustomBand;
      var PrintBand: Boolean);
    procedure QuickRep7BeforePrint(Sender: TCustomQuickRep;
      var PrintReport: Boolean);
  private
    { Déclarations privées }
    opt:shortint;

    periodeDe,periodeA,Ligne:string;
    AvecTaux,isViewSource,InclurAN:boolean;
    function CalculerSolde(param,perDe,perA:string):real;
    procedure MiseAJourTVA;
  public
    { Déclarations publiques }
    procedure Imprimeo(et,perDe,perA,Lg:string;avectx:boolean;typ,option:shortint;viewSource,InclureAN:boolean);
  end;

var
  FEtatTaxe: TFEtatTaxe;

implementation

uses Daspecia, DaCommun,  TypeElmt, USQL, UPStocke;

{$R *.DFM}

procedure TFEtatTaxe.Imprimeo(et,perDe,perA,Lg:string;avectx:boolean;typ,option:shortint;viewSource,InclureAN:boolean);
begin
 inclurAN:=InclureAN;
 isViewSource:=viewSource;
 periodeDe:=perDe;
 periodeA:=perA;
 avecTaux:=avectx;
 opt:=option;
 Ligne:=Lg;
 case typ of
   0:QuickRep9.preview;
   1:begin
       if Lg='Ligne1ab' then
         QuickRep2.Preview
       else if (Lg>='Ligne5')and (Lg<='Ligne5Z') then
         QuickRep1.Preview
       else
         QuickRep4.Preview;
     end;
   2:QuickRep3.Preview;
   3:QuickRep5.Preview;
   4:QuickRep6.Preview;
 end;
end;

procedure TFEtatTaxe.QRBand11BeforePrint(Sender: TQRCustomBand;
  var PrintBand: Boolean);
begin
{  if DASQL.DetTaxeQte.Value=0 then
    QRBand11.Font.Style:=[fsbold]
  else
    QRBand11.Font.Style:=[];}
end;

procedure TFEtatTaxe.QRDBText31Print(sender: TObject; var Value: String);
var i:word;
begin
  i:=strtoint(copy(value,6,2));
  value:=special.stmois[i]+ ' '+copy(value,1,4);
end;


procedure TFEtatTaxe.QRBand38BeforePrint(Sender: TQRCustomBand;
  var PrintBand: Boolean);
begin
  if avecTaux then
  begin
    if length(DASQL.DetTaxeNom.Value)>0 then
      QRBand38.Height:=0
    else
      QRBand38.Height:=18;
  end
end;

function TFEtatTaxe.CalculerSolde(param,perDe,perA:string):real;
begin
  PStockee.RCalculSolde.close;
  PStockee.RCalculSolde.SQL.Clear;
  PStockee.RCalculSolde.SQL.Add('select sum(SMontant) as solde from CalculSolde t');
  PStockee.RCalculSolde.SQL.Add('   where(t.periode>='''+perDe+''')and(t.periode<='''+perA+'Z'')');
  DASQL.SelParaDecl.close;
  DASQL.SelParaDecl.Parameters[1].Value:=param;
  DASQL.SelParaDecl.Parameters[2].Value:=param+'Z';
  DASQL.SelParaDecl.Open;
  if not DASQL.SelParaDecl.EOF then
  begin
    PStockee.RCalculSolde.SQL.Add('  and(');
    while not DASQL.SelParaDecl.EOF do
    begin
      PStockee.RCalculSolde.SQL.Add('((t.Compte>='''+EnleveBlanc(DASQL.SelParaDeclCompteDe.Value)+''')'+
      'and(t.Compte<'''+EnleveBlanc(DASQL.SelParaDeclCompteA.Value)+'Z''))');
      DASQL.SelParaDecl.Next;
      if not DASQL.SelParaDecl.EOF then PStockee.RCalculSolde.SQL.Add(' or ');
    end;
    PStockee.RCalculSolde.SQL.Add(')');
  end;
  PStockee.RCalculSolde.Open;
  result:=PStockee.RCalculSoldeSolde.Value;
end;

procedure TFEtatTaxe.QuickRep9BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
 var izy:boolean;
   mois1,mois2,i:integer;
   a1,b1,c1,d1,e1,
   a21,b21,c21,d21,e21,
   a22,b22,c22,d22,e22,
   a3,b3,c3,d3,e3,
   f51,g51,h51,f52,g52,h52,f53,g53,h53,f6,g6,h6,
   l7,l8,l9,l10,l11,l12,l13,l14:real;
begin
  izy:=true;
  mois1:=Strtoint(copy(periodede,6,2));
  mois2:=Strtoint(copy(periodeA,6,2));
  if mois1=mois2 then
  begin
    QRLabel3.Caption:='X';
    QRLabel7.Caption:=copy(periodede,6,2);
    QRLabel9.Caption:=copy(periodede,1,4);
    QRLabel4.Caption:='';QRLabel8.Caption:='';QRLabel10.Caption:='';
  end
  else
  begin
    QRLabel3.Caption :='';QRLabel7.Caption:='';QRLabel9.Caption:='';
    QRLabel4.Caption :='X';
    QRLabel8.Caption :=IntToStr(mois1 div 3 +1);
    QRLabel10.Caption:=copy(periodede,1,4);
  end;
  if mois2-mois1=1 then
  begin
     QRLabel309.Caption:='X';
     QRLabel7.Caption:=copy(periodede,6,2);
     QRLabel9.Caption:=copy(periodede,1,4);
  end
  else if mois2-mois1=3 then
  begin
    QRLabel315.Caption:='X';
    QRLabel8.Caption:=FormatFloat('00',(mois1 div 3)+1);
    QRLabel10.Caption:=copy(periodede,1,4);
  end;

  {Opération à l'exportation taxable a1}
  a1:=-CalculerSolde('Ligne1ab',periodeDe,periodeA);
  QRLabel388.Caption:=formatfloat('#,##0',a1);

  {Opération à l'exportation non taxale b1}
  b1:=0;
  if b1<0 then b1:=0;
  c1:=a1+b1;
  d1:=0;
  e1:=round(a1*d1);
  QRLabel389.Caption:=formatfloat('#,##0',b1);
  QRLabel390.Caption:=formatfloat('#,##0',c1);

  {Opération locale}
  PStockee.RTaxe.close;
  PStockee.RTaxe.SQL.Clear;        {from }
  PStockee.RTaxe.SQL.Add('select * from Taxe t');
  PStockee.RTaxe.SQL.Add('  where(t.periode>=:a)and(t.periode<=:b)');
  case opt of
    0:;
    1:{Assujeti et exoneré du compte}
      begin
        PStockee.RTaxe.SQL.Add('  and(t.exonere=:e)');
        PStockee.RTaxe.SQL.Add('and (t.exonere1=:g)');
      end;
    2:;
  end;
  DASQL.SelParaDecl.close;
  DASQL.SelParaDecl.Parameters[1].Value:='Ligne2ab';
  DASQL.SelParaDecl.Parameters[2].Value:='Ligne2abZ';
  DASQL.SelParaDecl.Open;
  if not DASQL.SelParaDecl.EOF then
  begin
    PStockee.RTaxe.SQL.Add('  and(');
    while not DASQL.SelParaDecl.EOF do
    begin
      PStockee.RTaxe.SQL.Add('((t.Compte>='''+EnleveBlanc(DASQL.SelParaDeclCompteDe.Value)+''')'+
      'and(t.Compte<'''+EnleveBlanc(DASQL.SelParaDeclCompteA.Value)+'Z''))');
      DASQL.SelParaDecl.Next;
      if not DASQL.SelParaDecl.EOF then PStockee.RTaxe.SQL.Add(' or ');
    end;
    PStockee.RTaxe.SQL.Add(')');
  end;
  PStockee.RTaxe.SQL.Add(' order by t.Compte');
  PStockee.RTaxe.Parameters[0].Value:=periodede;
  PStockee.RTaxe.Parameters[1].Value:=periodea;
  a21:=0;
  a22:=0;
  b21:=0;
  b22:=0;
  case opt of
    0:{}
    begin
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        {Ventes à des personnes  assujetti taxable a21a}
        if copy(PStockee.RTaxeCompte.Value,7,2)='03' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            a21:=a21+ PStockee.RTaxeMontant.Value
          else
            a21:=a21- PStockee.RTaxeMontant.Value;
        end;
        {Ventes à des personnes non assujetti taxable a22}
        if copy(PStockee.RTaxeCompte.Value,7,2)='04' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            a22:=a22+ PStockee.RTaxeMontant.Value
          else
            a22:=a22- PStockee.RTaxeMontant.Value;
        end;
        {Ventes à des personnes  assujetti non taxable b21}
        if copy(PStockee.RTaxeCompte.Value,7,2)='05' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            b21:=b21+ PStockee.RTaxeMontant.Value
          else
            b21:=b21- PStockee.RTaxeMontant.Value;
        end;
        {Ventes à des personnes  non assujetti non taxable b22}
        if copy(PStockee.RTaxeCompte.Value,7,2)='06' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            b22:=b22+ PStockee.RTaxeMontant.Value
          else
            b22:=b22- PStockee.RTaxeMontant.Value;
        end;
        PStockee.RTaxe.Next;
      end;
    end;
    1:{Assujeti et exoneré du compte}
    begin
      {Ventes à des personnes  assujetti taxable a21a}
      PStockee.RTaxe.Parameters[2].Value:=not izy;
      PStockee.RTaxe.Parameters[3].Value:=NOT izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          a21:=a21+ PStockee.RTaxeMontant.Value
        else
          a21:=a21- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
      {Ventes à des personnes  assujetti non taxable }
      PStockee.RTaxe.Parameters[2].Value:=izy;
      PStockee.RTaxe.Parameters[3].Value:=NOT izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          b21:=b21+ PStockee.RTaxeMontant.Value
        else
          b21:=b21- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
      {Ventes à des personnes non assujetti taxable}
      PStockee.RTaxe.Parameters[2].Value:=not izy;
      PStockee.RTaxe.Parameters[3].Value:=izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          a22:=a22+ PStockee.RTaxeMontant.Value
        else
          a22:=a22- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
      {Ventes à des personnes non assujetti non taxable}
      PStockee.RTaxe.Parameters[2].Value:=not izy;
      PStockee.RTaxe.Parameters[3].Value:=izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          b22:=b22+ PStockee.RTaxeMontant.Value
        else
          b22:=b22- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
    end;
    2:;
  end;

  QRLabel392.Caption:=formatfloat('#,##0',a21);
  QRLabel454.Caption:=formatfloat('#,##0',B21);
  c21:=a21+b21;
  d21:=Commun.TVAGeneraleTaux.Value/100;
  QRLabel393.Caption:=formatfloat('#,##0',c21);
  QRLabel394.Caption:='18%';
  QRLabel396.Caption:=formatfloat('#,##0',a22);
  QRLabel397.Caption:=formatfloat('#,##0',b22);
  c22:=a22+b22;
  d22:=Commun.TVAGeneraleTaux.Value/100;
  QRLabel398.Caption:=formatfloat('#,##0',c22);
  QRLabel399.Caption:=formatfloat('0%',d22*100);

  {Autre Régularisation taxable a3}
  PStockee.RTaxe.close;
  PStockee.RTaxe.SQL.Clear;
  PStockee.RTaxe.SQL.Add('select * from Taxe t');
  PStockee.RTaxe.SQL.Add('where (t.periode>=:a)and(t.periode<=:b)');

  DASQL.SelParaDecl.close;
  DASQL.SelParaDecl.Parameters[1].Value:='Ligne3ab';
  DASQL.SelParaDecl.Parameters[2].Value:='Ligne3abZ';
  DASQL.SelParaDecl.Open;
  if not DASQL.SelParaDecl.EOF then
  begin
    PStockee.RTaxe.SQL.Add('  and(');
    while not DASQL.SelParaDecl.EOF do
    begin
      PStockee.RTaxe.SQL.Add('((t.Compte>='''+EnleveBlanc(DASQL.SelParaDeclCompteDe.Value)+''')'+
      'and(t.Compte<'''+EnleveBlanc(DASQL.SelParaDeclCompteA.Value)+'Z''))');
      DASQL.SelParaDecl.Next;
      if not DASQL.SelParaDecl.EOF then PStockee.RTaxe.SQL.Add(' or ');
    end;
    PStockee.RTaxe.SQL.Add(')');
  end;
  PStockee.RTaxe.Parameters[0].Value:=periodede;
  PStockee.RTaxe.Parameters[1].Value:=periodea;
  PStockee.RTaxe.Open;

  a3:=0;
  b3:=0;
  while not PStockee.RTaxe.eof do
  begin
    if  PStockee.RTaxeExonere.Value=0 then
    begin
      if PStockee.RTaxeDebit.Value='D' then
        a3:=a3+ PStockee.RTaxeMontant.Value
      else
        a3:=a3- PStockee.RTaxeMontant.Value;
    end
    else
    begin
      if PStockee.RTaxeDebit.Value='D' then
        b3:=b3+ PStockee.RTaxeMontant.Value
      else
        b3:=b3- PStockee.RTaxeMontant.Value;
    end;
    PStockee.RTaxe.Next;
  end;
  a3:=-a3;
  QRLabel451.Caption:=formatfloat('#,##0',a3);

  {Autre Régularisation Non Taxable b3}
  b3:=-b3;
  {repère}
  c3:=a3+b3;
  d3:=0.2;
  QRLabel423.Caption:=formatfloat('#,##0',b3);
  QRLabel424.Caption:=formatfloat('#,##0',c3);
  QRLabel425.Caption:=formatfloat('18%',d3);
  QRLabel402.Caption:=formatfloat('#,##0',a1+a21+a22+a3);
  QRLabel403.Caption:=formatfloat('#,##0',b1+b21+b22+b3);
  QRLabel404.Caption:=formatfloat('#,##0',c1+c21+c22+c3);

 if avecTaux then
  begin
    e21:=round(a21*d21);
    e22:=round(a22*d22);
    e3:=round(a3*d3);
  end
  else
  begin
    {Calcule de e21,e22,e3}
    e21:=-CalculerSolde('Ligne21e',periodeDe,periodeA);
    e22:=-CalculerSolde('Ligne22e',periodeDe,periodeA);
    e3:=-CalculerSolde('Ligne3e',periodeDe,periodeA);
    {repère}
  end;
  QRLabel395.Caption:=formatfloat('#,##0',e21);
  QRLabel400.Caption:=formatfloat('#,##0',e22);
  QRLabel426.Caption:=formatfloat('#,##0',e3);
  QRLabel405.Caption:=formatfloat('#,##0',e1+e21+e22+e3);

  {calcule f51}
  f51:=CalculerSolde('Ligne51f',periodeDe,periodeA);
  QRLabel427.Caption:=formatfloat('#,##0',f51);
  {calcule g51}
  g51:=CalculerSolde('Ligne51g',periodeDe,periodeA);
  h51:=f51+g51;
  QRLabel428.Caption:=formatfloat('#,##0',g51);
  QRLabel429.Caption:=formatfloat('#,##0',h51);

  {calcule f52}
  f52:=CalculerSolde('Ligne52f',periodeDe,periodeA);
  QRLabel430.Caption:=formatfloat('#,##0',f52);

  {calcule g52}
  g52:=CalculerSolde('Ligne52g',periodeDe,periodeA);
  h52:=f52+g52;
  QRLabel431.Caption:=formatfloat('#,##0',g52);
  QRLabel432.Caption:=formatfloat('#,##0',h52);

  {calcule f53}
  f53:=CalculerSolde('Ligne53f',periodeDe,periodeA);
  QRLabel433.Caption:=formatfloat('#,##0',f53);

  {calcule g53}
  g53:=CalculerSolde('Ligne53g',periodeDe,periodeA);
  h53:=f53+g53;
  QRLabel434.Caption:=formatfloat('#,##0',g53);
  QRLabel435.Caption:=formatfloat('#,##0',h53);


  f6:=0;
  g6:=0;
  h6:=f6+g6;
  QRLabel436.Caption:=formatfloat('#,##0',f6);
  QRLabel437.Caption:=formatfloat('#,##0',g6);
  QRLabel438.Caption:=formatfloat('#,##0',h6);
  l7:=h51+h52+h53;
  QRLabel443.Caption:=formatfloat('#,##0',l7);
  try
    l8:=strtofloat(InputBox('Déclaration TVA', 'Entrez le taux prorata', '100'));
    QRLabel453.Caption:=FormatFloat('0.00',l8);
  except
    On EConvertError do l8:=100;
  end;
  l8:=l8*l7/100;
  QRLabel444.Caption:=formatfloat('#,##0',l8);

  {calcule l9}
  l9:=CalculerSolde('Ligne9','0',periodeA);
  QRLabel445.Caption:=formatfloat('#,##0',l9);

  l10:=l8+l9;
  QRLabel446.Caption:=formatfloat('#,##0',l10);
  if e1+e21+e22+e3-l10>0 then
  begin
    l11:=e1+e21+e22+e3-l10;
    l12:=0;
  end
  else
  begin
    l12:=-(e1+e21+e22+e3-l10);
    l11:=0;
  end;
  l13:=0;
  QRLabel447.Caption:=formatfloat('#,##0',l11);
  QRLabel448.Caption:=formatfloat('#,##0',l12);
  QRLabel449.Caption:=formatfloat('#,##0',l13);
  l14:=l12-l13;
  QRLabel450.Caption:=formatfloat('#,##0',l14);
end;

//=================================================

procedure TFEtatTaxe.MiseAJourTVA;
 var izy:boolean;
   mois1,mois2,i:integer;
   a1,b1,c1,d1,e1,a,b,c,e,
   a21,b21,c21,d21,e21,
   a22,b22,c22,d22,e22,
   a3,b3,c3,d3,e3,
   f51,g51,h51,f52,g52,h52,f53,g53,h53,f6,g6,h6,
   l7,l8,l9,l10,l11,l12,l13,l14:real;

 procedure Vider;
 begin
   daSQL.Q_ParamTVA.close;
   daSQL.Q_ParamTVA.Parameters[0].Value :=Commun.SocieteCode.Value;
   daSQL.Q_ParamTVA.Parameters[1].Value :=mois1;
   daSQL.Q_ParamTVA.Parameters[2].Value :=mois2;
   daSQL.Q_ParamTVA.Open;
   while not daSQL.Q_ParamTVA.EOF do daSQL.Q_ParamTVA.Delete;

   daSQL.Et_NouveauTVA.close;
   daSQL.Et_NouveauTVA.Parameters[0].Value :=Commun.SocieteCode.Value;
   daSQL.Et_NouveauTVA.Parameters[1].Value :=mois1;
   daSQL.Et_NouveauTVA.Parameters[2].Value :=mois2;
 end;

 procedure Inserer(cody:string;valeur:real);
 begin
   daSQL.Q_ParamTVA.Insert;
   daSQL.Q_ParamTVACody.Value:=Cody;
   daSQL.Q_ParamTVASociete.Value :=Commun.SocieteCode.Value;
   daSQL.Q_ParamTVAMoisDe.Value :=mois1;
   daSQL.Q_ParamTVAMoisA.Value :=mois2;
   daSQL.Q_ParamTVAValeur.Value :=valeur;
   daSQL.Q_ParamTVA.Post;
 end;
begin
  izy:=true;
  mois1:=Strtoint(copy(periodede,6,2));
  mois2:=Strtoint(copy(periodeA,6,2));

  Vider;
  {Opération à l'exportation taxable a1}

  a1:=-CalculerSolde('Ligne1ab',periodeDe,periodeA);
  {Opération à l'exportation non taxale b1}
  b1:=0;
  if b1<0 then b1:=0;
  c1:=a1+b1;
  d1:=0;
  e1:=round(a1*d1);

  {Opération locale}
  PStockee.RTaxe.close;
  PStockee.RTaxe.SQL.Clear;        {from }
  PStockee.RTaxe.SQL.Add('select * from Taxe t');
  PStockee.RTaxe.SQL.Add('  where(t.periode>=:a)and(t.periode<=:b)');
  case opt of
    0:;
    1:{Assujeti et exoneré du compte}
      begin
        PStockee.RTaxe.SQL.Add('  and(t.exonere=:e)');
        PStockee.RTaxe.SQL.Add('and (t.exonere1=:g)');
      end;
    2:;
  end;

  DASQL.SelParaDecl.close;
  DASQL.SelParaDecl.Parameters[1].Value:='Ligne2ab';
  DASQL.SelParaDecl.Parameters[2].Value:='Ligne2abZ';
  DASQL.SelParaDecl.Open;

  if not DASQL.SelParaDecl.EOF then
  begin
    PStockee.RTaxe.SQL.Add('  and(');
    while not DASQL.SelParaDecl.EOF do
    begin
      PStockee.RTaxe.SQL.Add('((t.Compte>='''+EnleveBlanc(DASQL.SelParaDeclCompteDe.Value)+''')'+
      'and(t.Compte<'''+EnleveBlanc(DASQL.SelParaDeclCompteA.Value)+'Z''))');
      DASQL.SelParaDecl.Next;
      if not DASQL.SelParaDecl.EOF then PStockee.RTaxe.SQL.Add(' or ');
    end;
    PStockee.RTaxe.SQL.Add(')');
  end;
  PStockee.RTaxe.SQL.Add(' order by t.Compte');
  PStockee.RTaxe.Parameters[0].Value:=periodede;
  PStockee.RTaxe.Parameters[1].Value:=periodea;
  a21:=0;
  a22:=0;
  b21:=0;
  b22:=0;
  case opt of
    0:{}
    begin
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        {Ventes à des personnes  assujetti taxable a21a}
        if copy(PStockee.RTaxeCompte.Value,7,2)='03' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            a21:=a21+ PStockee.RTaxeMontant.Value
          else
            a21:=a21- PStockee.RTaxeMontant.Value;
        end;
        {Ventes à des personnes non assujetti taxable a22}
        if copy(PStockee.RTaxeCompte.Value,7,2)='04' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            a22:=a22+ PStockee.RTaxeMontant.Value
          else
            a22:=a22- PStockee.RTaxeMontant.Value;
        end;
        {Ventes à des personnes  assujetti non taxable b21}
        if copy(PStockee.RTaxeCompte.Value,7,2)='05' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            b21:=b21+ PStockee.RTaxeMontant.Value
          else
            b21:=b21- PStockee.RTaxeMontant.Value;
        end;
        {Ventes à des personnes  non assujetti non taxable b22}
        if copy(PStockee.RTaxeCompte.Value,7,2)='06' then
        begin
          if PStockee.RTaxeDebit.Value='C' then
            b22:=b22+ PStockee.RTaxeMontant.Value
          else
            b22:=b22- PStockee.RTaxeMontant.Value;
        end;
        PStockee.RTaxe.Next;
      end;
    end;
    1:{Assujeti et exoneré du compte}
    begin
      {Ventes à des personnes  assujetti taxable a21a}
      PStockee.RTaxe.Parameters[2].Value:=not izy;
      PStockee.RTaxe.Parameters[3].Value:=NOT izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          a21:=a21+ PStockee.RTaxeMontant.Value
        else
          a21:=a21- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
      {Ventes à des personnes  assujetti non taxable }
      PStockee.RTaxe.Parameters[2].Value:=izy;
      PStockee.RTaxe.Parameters[3].Value:=NOT izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          b21:=b21+ PStockee.RTaxeMontant.Value
        else
          b21:=b21- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
      {Ventes à des personnes non assujetti taxable}
      PStockee.RTaxe.Parameters[2].Value:=not izy;
      PStockee.RTaxe.Parameters[3].Value:=izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          a22:=a22+ PStockee.RTaxeMontant.Value
        else
          a22:=a22- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
      {Ventes à des personnes non assujetti non taxable}
      PStockee.RTaxe.Parameters[2].Value:=not izy;
      PStockee.RTaxe.Parameters[3].Value:=izy;
      PStockee.RTaxe.Open;
      while not PStockee.RTaxe.eof do
      begin
        if PStockee.RTaxeDebit.Value='C' then
          b22:=b22+ PStockee.RTaxeMontant.Value
        else
          b22:=b22- PStockee.RTaxeMontant.Value;
        PStockee.RTaxe.Next;
      end;
    end;
    2:;
  end;

  c21:=a21+b21;
  d21:=Commun.TVAGeneraleTaux.Value/100;

  c22:=a22+b22;
  d22:=Commun.TVAGeneraleTaux.Value/100;

  {Autre Régularisation taxable a3}
  PStockee.RTaxe.close;
  PStockee.RTaxe.SQL.Clear;
  PStockee.RTaxe.SQL.Add('select * from Taxe t');
  PStockee.RTaxe.SQL.Add('where (t.periode>=:a)and(t.periode<=:b)');

  DASQL.SelParaDecl.close;
  DASQL.SelParaDecl.Parameters[1].Value:='Ligne3ab';
  DASQL.SelParaDecl.Parameters[2].Value:='Ligne3abZ';
  DASQL.SelParaDecl.Open;
  if not DASQL.SelParaDecl.EOF then
  begin
    PStockee.RTaxe.SQL.Add('  and(');
    while not DASQL.SelParaDecl.EOF do
    begin
      PStockee.RTaxe.SQL.Add('((t.Compte>='''+EnleveBlanc(DASQL.SelParaDeclCompteDe.Value)+''')'+
      'and(t.Compte<'''+EnleveBlanc(DASQL.SelParaDeclCompteA.Value)+'Z''))');
      DASQL.SelParaDecl.Next;
      if not DASQL.SelParaDecl.EOF then PStockee.RTaxe.SQL.Add(' or ');
    end;
    PStockee.RTaxe.SQL.Add(')');
  end;
  PStockee.RTaxe.Parameters[0].Value:=periodede;
  PStockee.RTaxe.Parameters[1].Value:=periodea;
  PStockee.RTaxe.Open;

  a3:=0;
  b3:=0;
  while not PStockee.RTaxe.eof do
  begin
    if  PStockee.RTaxeExonere.Value=0 then
    begin
      if PStockee.RTaxeDebit.Value='D' then
        a3:=a3+ PStockee.RTaxeMontant.Value
      else
        a3:=a3- PStockee.RTaxeMontant.Value;
    end
    else
    begin
      if PStockee.RTaxeDebit.Value='D' then
        b3:=b3+ PStockee.RTaxeMontant.Value
      else
        b3:=b3- PStockee.RTaxeMontant.Value;
    end;
    PStockee.RTaxe.Next;
  end;
  a3:=-a3;
  QRLabel451.Caption:=formatfloat('#,##0',a3);

  {Autre Régularisation Non Taxable b3}
  b3:=-b3;
  {repère}
  c3:=a3+b3;
  d3:=0.2;
  a:=a1+a21+a22+a3;
  b:=b1+b21+b22+b3;
  c:=c1+c21+c22+c3;

 if avecTaux then
  begin
    e21:=round(a21*d21);
    e22:=round(a22*d22);
    e3:=round(a3*d3);
  end
  else
  begin
    {Calcule de e21,e22,e3}
    e21:=-CalculerSolde('Ligne21e',periodeDe,periodeA);
    e22:=-CalculerSolde('Ligne22e',periodeDe,periodeA);
    e3:=-CalculerSolde('Ligne3e',periodeDe,periodeA);
    {repère}
  end;
  e:=e1+e21+e22+e3;

  {calcule f51}
  f51:=CalculerSolde('Ligne51f',periodeDe,periodeA);
  {calcule g51}
  g51:=CalculerSolde('Ligne51g',periodeDe,periodeA);
  h51:=f51+g51;

  {calcule f52}
  f52:=CalculerSolde('Ligne52f',periodeDe,periodeA);

  {calcule g52}
  g52:=CalculerSolde('Ligne52g',periodeDe,periodeA);
  h52:=f52+g52;

  {calcule f53}
  f53:=CalculerSolde('Ligne53f',periodeDe,periodeA);

  {calcule g53}
  g53:=CalculerSolde('Ligne53g',periodeDe,periodeA);
  h53:=f53+g53;
  f6:=0;
  g6:=0;
  h6:=f6+g6;

  l7:=h51+h52+h53;
  try
    l8:=strtofloat(InputBox('Déclaration TVA', 'Entrez le taux prorata', '100'));
  except
    On EConvertError do l8:=100;
  end;
  l8:=l8*l7/100;

  {calcule l9}
  l9:=CalculerSolde('Ligne9','0',periodeA);

  l10:=l8+l9;

  if e1+e21+e22+e3-l10>0 then
  begin
    l11:=e1+e21+e22+e3-l10;
    l12:=0;
  end
  else
  begin
    l12:=-(e1+e21+e22+e3-l10);
    l11:=0;
  end;
  l13:=0;
  l14:=l12-l13;

  Inserer('a',a);   Inserer('b',b);   Inserer('c',c);   Inserer('e',e);
  Inserer('a1',a1);   Inserer('b1',b1);   Inserer('c1',c1);   Inserer('d1',d1);
  Inserer('e1',e1);   Inserer('a21',a21); Inserer('b21',b21); Inserer('c21',c21);
  Inserer('d21',d21); Inserer('e21',e21); Inserer('a22',a22); Inserer('b22',b22);
  Inserer('c22',c22); Inserer('d22',d22); Inserer('e22',e22); Inserer('a3',a3);
  Inserer('b3',b3);   Inserer('c3',c3);   Inserer('d3',d3);   Inserer('e3',e3);
  Inserer('f51',f51); Inserer('g51',g51); Inserer('h51',h51); Inserer('f52',f52);
  Inserer('g52',g52); Inserer('h52',h52); Inserer('f53',f53); Inserer('g53',g53);
  Inserer('h53',h53); Inserer('f6',f6);   Inserer('g6',g6);   Inserer('h6',h6);
  Inserer('l7',l7);   Inserer('l8',l8);   Inserer('l9',l9);   Inserer('l10',l10);
  Inserer('l11',l11); Inserer('l12',l12); Inserer('l13',l13); Inserer('l14',l14);

   daSQL.Et_NouveauTVA.Open;
end;

procedure TFEtatTaxe.QuickRep1BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
begin
  if not isViewSource then QRLabel240.Caption:='';
  DASQL.DetTaxe.close;
  DASQL.DetTaxe.SQL.Clear;
  DASQL.DetTaxe.SQL.Add('select * from Declare x ');
  DASQL.DetTaxe.SQL.Add('Where (x.periode>=:a)and(x.periode<=:b)');
  DASQL.DetTaxe.SQL.Add('and (x.Rubrique>='''+Ligne+''')and(x.Rubrique<='''+Ligne+'Z'')');
  if not InclurAN then
    DASQL.DetTaxe.SQL.Add('and (x.Typ<4)');
  DASQL.DetTaxe.SQL.Add('order by x.Compte, x.DateEsc');
  DASQL.DetTaxe.Parameters[0].Value:=periodede;
  DASQL.DetTaxe.Parameters[1].Value:=periodea;
  DASQL.DetTaxe.Open;
   {Showmessage(inttostr(DASQL.DetTaxe.recordCount)+' élements');}
  if Ligne='Ligne51f' then QRLabel43.Caption:='Sur des biens d''équipements et immeubles-Locaux' ;
  if Ligne='Ligne52f' then QRLabel43.Caption:='Sur les autres biens - Locaux' ;
  if Ligne='Ligne53f' then QRLabel43.Caption:='Sur les services - Locaux' ;
  if Ligne='Ligne51g' then QRLabel43.Caption:='Sur des biens d''équipements et immeubles-Importation' ;
  if Ligne='Ligne52g' then QRLabel43.Caption:='Sur les autres biens-Importation' ;
  if Ligne='Ligne53g' then QRLabel43.Caption:='Sur les services-Importation' ;
end;

procedure TFEtatTaxe.QuickRep2BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
var x:integer;
begin
  if not isViewSource then QRLabel111.Caption:='';
{  if avecTaux then QRBand11.Height:=0
  else QRBand11.Height:=19 ; }
  DASQL.DetTaxe.close;
  DASQL.DetTaxe.SQL.Clear;
  DASQL.DetTaxe.SQL.Add('select * from Declare x');
  DASQL.DetTaxe.SQL.Add('Where (x.periode>=:a)and(x.periode<=:b)');
  DASQL.DetTaxe.SQL.Add('and (x.Rubrique>='''+Ligne+''')and(x.Rubrique<='''+Ligne+'Z'')');
  if not InclurAN then
    DASQL.DetTaxe.SQL.Add('and (x.Typ<4)');
  DASQL.DetTaxe.SQL.Add('order by x.compte, x.DateEsc');
  DASQL.DetTaxe.Parameters[0].Value:=periodede;
  DASQL.DetTaxe.Parameters[1].Value:=periodea;
  DASQL.DetTaxe.Open;
  x:=strtoint(copy(periodede,6,2));
  QRLabel23.Caption:= 'EXPORTATION mois de '+special.stmois[x]+' '+copy(periodede,1,4);
end;

procedure TFEtatTaxe.QuickRep4BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
begin
  if not isViewSource then QRLabel112.Caption:='';
  DASQL.DetTaxe.close;
  DASQL.DetTaxe.SQL.Clear;
  DASQL.DetTaxe.SQL.Add('select * from Declare x');
  DASQL.DetTaxe.SQL.Add('Where (x.periode>=:a)and(x.periode<=:b)');
  DASQL.DetTaxe.SQL.Add('and (x.Rubrique>='''+Ligne+''')and(x.Rubrique<='''+Ligne+'Z'')');
  if not InclurAN then
    DASQL.DetTaxe.SQL.Add('and (x.Typ<4)');
  DASQL.DetTaxe.SQL.Add('order by x.periode, x.code');
  DASQL.DetTaxe.Parameters[0].Value:=periodede;
  DASQL.DetTaxe.Parameters[1].Value:=periodea;
  DASQL.DetTaxe.Open;
 Detail.Caption:= 'Détail '+ Ligne;
end;

procedure TFEtatTaxe.QuickRep3BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
var annee,mois:word;
  dtfin:Tdate;
begin
  if not isViewSource then QRLabel113.Caption:='';
  QRLabel93.Caption:='01/'+copy(periodeDe,6,2)+'/'+copy(periodeDe,1,4);
  annee:=StrToInt(copy(periodeA,1,4));
  mois:=StrToInt(copy(periodeA,6,2));
  dtfin:=MetterFinMois(annee,mois);
  QRLabel94.Caption:=DateTimeTostr(dtfin);
  DASQL.DetTaxe.close;
  DASQL.DetTaxe.SQL.Clear;
  DASQL.DetTaxe.SQL.Add('select * from Declare x ');
  DASQL.DetTaxe.SQL.Add('Where (x.periode>=:a)and(x.periode<=:b)');
  DASQL.DetTaxe.SQL.Add('and (x.Rubrique>='''+Ligne+''')and(x.Rubrique<='''+Ligne+'Z'')');
  if not InclurAN then
    DASQL.DetTaxe.SQL.Add('and (x.Typ<4)');
  DASQL.DetTaxe.SQL.Add('order by x.compte, x.periode, x.code');
  DASQL.DetTaxe.Parameters[0].Value:=periodede;
  DASQL.DetTaxe.Parameters[1].Value:=periodea;
  DASQL.DetTaxe.Open;
  QRLabel47.Caption:= 'Recapitulatif par comptes '+ ligne +' suivant comptabilité';
  QRGroup4.Height:=0;
  QRBand24.Height:=0;
  if not avecTaux then //Détail
  begin
    QRGroup3.Height:=0;
    QRBand27.Height:=0;
  end;
  QRLabel116.Caption:= EnleveBlancDroite(Commun.SocieteRS.Value);
end;

procedure TFEtatTaxe.QuickRep6BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
var annee,mois:word;
  dtfin:Tdate;
begin
  if not isViewSource then QRLabel114.Caption:='';
  QRLabel97.Caption:='01/'+copy(periodeDe,6,2)+'/'+copy(periodeDe,1,4);
  annee:=StrToInt(copy(periodeA,1,4));
  mois:=StrToInt(copy(periodeA,6,2));
  dtfin:=MetterFinMois(annee,mois);
  QRLabel98.Caption:=DateTimeTostr(dtfin);
  DASQL.DetTaxe.close;
  DASQL.DetTaxe.SQL.Clear;
  DASQL.DetTaxe.SQL.Add('select * from Declare x ');
  DASQL.DetTaxe.SQL.Add('Where (x.periode>=:a)and(x.periode<=:b)');
  DASQL.DetTaxe.SQL.Add('and (x.Rubrique>='''+Ligne+''')and(x.Rubrique<='''+Ligne+'Z'')');
  if not InclurAN then
    DASQL.DetTaxe.SQL.Add('and (x.Typ<4)');
  DASQL.DetTaxe.SQL.Add('order by x.Compte, x.code');
  DASQL.DetTaxe.Parameters[0].Value:=periodede;
  DASQL.DetTaxe.Parameters[1].Value:=periodea;
  DASQL.DetTaxe.Open;
  if Ligne='VENTE' then QRLabel77.Caption:= 'Détail ventes à déclarer';
  if Ligne='ACHAT PL' then QRLabel77.Caption:= 'Détail achats à déclarer';
end;

procedure TFEtatTaxe.QuickRep5BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
var annee,mois:word;
  dtfin:Tdate;
begin
  if not isViewSource then QRLabel115.Caption:='';
  QRLabel101.Caption:='01/'+copy(periodeDe,6,2)+'/'+copy(periodeDe,1,4);
  annee:=StrToInt(copy(periodeA,1,4));
  mois:=StrToInt(copy(periodeA,6,2));
  dtfin:=MetterFinMois(annee,mois);
  QRLabel102.Caption:=DateTimeTostr(dtfin);
  DASQL.DetTaxe.close;
  DASQL.DetTaxe.SQL.Clear;
  DASQL.DetTaxe.SQL.Add('select * from Declare x');
  DASQL.DetTaxe.SQL.Add('Where (x.periode>=:a)and(x.periode<=:b)');
  DASQL.DetTaxe.SQL.Add('and (x.Rubrique>='''+Ligne+''')and(x.Rubrique<='''+Ligne+'Z'')');
  if not InclurAN then
    DASQL.DetTaxe.SQL.Add('and (x.Typ<4)');
  DASQL.DetTaxe.SQL.Add('order by x.typX, x.Compte, x.code');
  DASQL.DetTaxe.Parameters[0].Value:=periodede;
  DASQL.DetTaxe.Parameters[1].Value:=periodea;
  DASQL.DetTaxe.Open;
  QRLabel50.Caption:= 'Détail prestations à déclarer';
end;

procedure TFEtatTaxe.QRBand33BeforePrint(Sender: TQRCustomBand;
  var PrintBand: Boolean);
begin
  QRLabel117.Caption:='('+EnleveBlancDroite(DASQL.DetTaxeTypX.Value)+')';
end;

procedure TFEtatTaxe.QuickRep7BeforePrint(Sender: TCustomQuickRep;
  var PrintReport: Boolean);
begin
  showMessage('début');
  MiseAJourTVA;
end;

end.
